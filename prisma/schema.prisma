generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String    @id @default(cuid())
  email              String    @unique
  passwordHash       String?
  name               String
  role               String    // employer | employee
  inviteToken        String?
  inviteTokenExpires DateTime?
  department         String?
  startDate          DateTime?
  address            String?
  contactNumber      String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  businessesOwned       Business[]          @relation("BusinessOwner")
  employeeBusinesses    BusinessEmployee[]  @relation("Employee")
  payslipsSent          Payslip[]           @relation("EmployerPayslips")
  payslipsReceived           Payslip[]           @relation("EmployeePayslips")
  scheduledPayslipsSent       ScheduledPayslip[]  @relation("EmployerScheduledPayslips")
  scheduledPayslipsReceived   ScheduledPayslip[]  @relation("EmployeeScheduledPayslips")
}

model Business {
  id              String   @id @default(cuid())
  name            String
  employerId      String
  address         String?  // business address / branding
  logoUrl         String?  // external logo URL
  logoPath        String?  // path to uploaded logo file
  payCycle        String?  // "weekly" | "monthly"
  payDayOfWeek    Int?     // 0=Sunday, 1=Monday, ... 6=Saturday (for weekly)
  payDayOfMonth   Int?     // 1-31 (for monthly)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  employer           User               @relation("BusinessOwner", fields: [employerId], references: [id], onDelete: Cascade)
  employees          BusinessEmployee[] @relation("BusinessEmployees")
  payslips           Payslip[]          @relation("BusinessPayslips")
  scheduledPayslips  ScheduledPayslip[] @relation("ScheduledPayslips")
}

model BusinessEmployee {
  businessId     String
  employeeId     String
  payCycle       String?  // "weekly" | "monthly" (how this employee is paid)
  payDayOfWeek   Int?     // 0=Sunday..6=Saturday (for weekly)
  payDayOfMonth  Int?     // 1-31 (for monthly)
  createdAt      DateTime @default(now())
  business       Business @relation("BusinessEmployees", fields: [businessId], references: [id], onDelete: Cascade)
  employee       User     @relation("Employee", fields: [employeeId], references: [id], onDelete: Cascade)

  @@id([businessId, employeeId])
}

model Payslip {
  id           String   @id @default(cuid())
  fileName     String
  filePath     String
  emailMessage String?
  amountCents  Int?     // optional payment amount in cents (for dashboard totals)
  businessId   String?  // required for new payslips; nullable for migration backfill
  employerId   String
  employeeId   String
  createdAt    DateTime @default(now())
  business     Business? @relation("BusinessPayslips", fields: [businessId], references: [id], onDelete: Cascade)
  employer     User     @relation("EmployerPayslips", fields: [employerId], references: [id], onDelete: Cascade)
  employee     User     @relation("EmployeePayslips", fields: [employeeId], references: [id], onDelete: Cascade)
}

model ScheduledPayslip {
  id           String   @id @default(cuid())
  fileName     String
  filePath     String   // blob URL or relative path; used when processing
  emailMessage String?
  amountCents  Int?
  businessId   String
  employerId   String
  employeeId   String
  scheduledAt  DateTime // when to send
  status       String   // pending | sent | failed
  sentAt       DateTime? // when actually sent
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  business     Business @relation("ScheduledPayslips", fields: [businessId], references: [id], onDelete: Cascade)
  employer     User     @relation("EmployerScheduledPayslips", fields: [employerId], references: [id], onDelete: Cascade)
  employee     User     @relation("EmployeeScheduledPayslips", fields: [employeeId], references: [id], onDelete: Cascade)
}
